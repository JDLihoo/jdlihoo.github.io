---
title: A-Ops安装使用
author: JDLihoo
date: 2025-10-10
category: Jekyll
layout: post
published: false
---
![picture 0](../images/gala-gopher.png#pic_center)
gala-gopher会将指标数据metrics输出到prometheus，将元数据metadata、异常事件event输出到kafka，灰色部分的gala-anteater和gala-spider会从prometheus和kafka获取数据。
## gala-gopher部署
### 源码编译运行
https://gitee.com/openeuler/gala-gopher  

执行gala-gopher前需要先设置文件权限
```
cd /opt/gala-gopher/extend_probes
chmod 777 cadvisor_probe.py
```

运行 `gala-gopher`

修改配置：  
`vim /etc/gala-gopher/gala-gopher.conf`    
元数据metadata、异常事件event要输出到kafka  
```
event =
{
    out_channel = "kafka";          # logs | kafka
    kafka_topic = "gala_gopher_event";
    timeout = 600;  # 10min
};

meta =
{
    out_channel = "kafka";          # logs | kafka
    kafka_topic = "gala_gopher_metadata";
};

kafka_broker = "192.168.140.132:9092";
```

### 验证安装是否成功
`curl http://localhost:8888`
如果返回没有报错，则部署成功

### 运行一个容器用于测试
可以用nginx
```
docker run -d --name nginx-chaos --privileged --pid=host --network=host -v /:/host -v /etc/localtime:/etc/localtime:ro -v /sys:/sys -v /usr/lib/debug:/usr/lib/debug -v /var/lib/docker:/var/lib/docker -v /opt:/opt -e GOPHER_HOST_PATH=/host nginx:latest
```
```
docker run -d --name gala-gopher --privileged --pid=host --network=host \
-v /:/host -v /etc/localtime:/etc/localtime:ro -v /sys:/sys \
-v /usr/lib/debug:/usr/lib/debug -v /var/lib/docker:/var/lib/docker \
-e GOPHER_HOST_PATH=/host \
hub.oepkgs.net/a-ops/gala-gopher-x86_64
```
### 开启探针
TODO
看test/gopher-probe/contain.sh
### 浏览器查看gala-gopher采集的数据


## gala-anteater部署
前置需要安装Prometheus和kafka
### Prometheus
```
yum install prometheus2 -y
vim /etc/prometheus/prometheus.yml
```
抓取监控数据的目标地址设置为gala-gopher的地址
```
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'gala-gopher'

    # Override the global default and scrape targets from this job every 5 seconds.
    # 这里设置为15s，因为gala-gopher的探针采集间隔约7-12s
    scrape_interval: 15s
    scrape_timeout: 15s

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    # '192.168.140.132:8888'
    static_configs:
      - targets: ['localhost:8888']
```
启动Prometheus：  
`systemctl start prometheus`  

本机浏览器上登录
http://192.168.140.132:9090/targets
若连接不上，检查服务器的防火墙
```
# 是否有9090端口
firewall-cmd --list-ports
# 若没有，则
firewall-cmd --add-port=8888/tcp --permanent
firewall-cmd --reload
```

如果出现204问题，查看是不是已经curl -X PUT了相应相应探测的容器，prometheus收不到数据就会204.  

### kafka
```
yum install zookeeper -y
systemctl start zookeeper

yum install kafka -y
vim /opt/kafka/config/server.properties
```
修改listeners 为本机ip
```
############################# Socket Server Settings #############################

# The address the socket server listens on. It will get the value returned from
# java.net.InetAddress.getCanonicalHostName() if not configured.
#   FORMAT:
#     listeners = listener_name://host_name:port
#   EXAMPLE:
#     listeners = PLAINTEXT://your.host.name:9092
#listeners=PLAINTEXT://:9092
listeners=PLAINTEXT://192.168.140.132:9092
```
tmux 后台运行kafka服务:
```
cd /opt/kafka/bin
./kafka-server-start.sh ../config/server.properties
```

## yum安装gala-anteater
https://gitee.com/openeuler/gala-anteater
```
yum install gala-anteater
```
修改配置文件，主要关注kafka和Prometheus的ip:端口
`/etc/gala-anteater/config/gala-anteater.yaml`
```
Global:
  data_source: "prometheus"

Arangodb:
  url: "http://localhost:8529"
  db_name: "spider"

Kafka:
  server: "192.168.140.132"
  port: "9092"
  model_topic: "gala_anteater_hybrid_model"
  rca_topic: "gala_cause_inference"
  meta_topic: "gala_gopher_metadata"
  group_id: "gala_anteater_kafka"
  # auth_type: plaintext/sasl_plaintext, please set "" for no auth
  auth_type: ""
  username: ""
  password: ""

Prometheus:
  server: "192.168.140.132"
  port: "9090"
  steps: "5"

Aom:
  base_url: ""
  project_id: ""
  auth_type: "token"
  auth_info:
    iam_server: ""
    iam_domain: ""
    iam_user_name: ""
    iam_password: ""
    ssl_verify: 0

Schedule:
  duration: 1

# 告警抑制时间
Suppression:
  interval: 10
```
启动gala-anteater
`systemctl start gala-anteater`

报错：
```
Q: ModuleNotFoundError: No module named 'pingouin'
A: pip3 install pingouin  # 注意在特定的python环境下安装
```

## gala-anteater 源码安装
```
git clone https://gitee.com/openeuler/gala-anteater.git
python3 setup.py install

vim /usr/lib/systemd/system/gala-anteater.service
```
```
[Unit]
Description=A-Ops gala-anteater service
After=network.target

[Service]
Type=exec
ExecStart=/root/miniconda3/envs/gala/bin/gala-anteater
Restart=on-failure
RestartSec=1
Environment="PATH=/root/miniconda3/envs/gala/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"

[Install]
WantedBy=multi-user.target
```
```
systemctl daemon-reload
systemctl restart gala-anteater
systemctl status gala-anteater
```
需关注配置：
`gala-anteater/config/module/container_disruption.jon.json`
`gala-anteater/config/gala-anteater.yaml`(这里存放关于kafka和prometheus的配置)
查看日志：  
`journalctl -f -xeu gala-anteater.service`

可能出现arangodb3相关的报错问题(可以直接忽略，不影响，不会因为报错而结束程序)：
```
# 安装arangodb3
curl -OL https://download.arangodb.com/arangodb310/RPM/arangodb.repo
mv arangodb.repo /etc/yum.repos.d/
yum install -y arangodb3

systemctl start arangodb3
systemctl enable arangodb3

# 设置root密码（首次启动后）
arango-secure-installation
```

### gala-anteater支持的异常检测场景
![picture 0](../images/gala-anteater1.png#pic_center)

运行
```
gala-anteater -ks 192.168.140.132 -kp 9092 -ps 192.168.140.132 -pp 9090 -m vae -r True -l 7 -t 0.6 -sli 400
```

查看日志
`/var/log/gala-anteater/gala-anteater.log`


## gala-anteater测试
### 故障注入
https://github.com/chaosblade-io/chaosblade.git

安装包下载：  
https://github.com/chaosblade-io/chaosblade/releases
```
wget https://chaosblade.oss-cn-hangzhou.aliyuncs.com/agent/github/1.8.0/chaosblade-1.8.0-linux_amd64.tar.gz
# Extract and install
tar -xzf chaosblade-1.8.0-[platform].tar.gz
cd chaosblade-1.8.0-[platform]

# Verify installation
./blade version
```

故障注入：  
`./blade create cpu fullload`  
返回：  
`{"code":200,"success":true,"result":"3f1cd351050d1729"}`  
结束：  
`./blade destroy 3f1cd351050d1729`  

其他类型故障：  
`./blade create network loss --percent 40 --interface ens160`

### 创建容器
需要创建一个容器，在容器内运行chaosblade，再指定给gala-gopher，让其去探测该容器，这样才能检测到容器问题，才会输出异常事件event等数据。  
```
docker run -it -d --net=host --privileged --name ubuntu-chaos ubuntu:latest /bin/bash
apt update
apt install -y wget iproute2
wget https://chaosblade.oss-cn-hangzhou.aliyuncs.com/agent/github/1.8.0/chaosblade-1.8.0-linux_amd64.tar.gz
tar -xzf chaosblade-1.8.0-linux_amd64.tar.gz
cd chaosblade-1.8.0-linux_amd64
./blade version
```

## 进程故障检测
```
# 运行个进程，要能持续建立tcp连接
wget https://mirrors.ocf.berkeley.edu/openeuler/openEuler-25.09/ISO/x86_64/openEuler-25.09-everything-x86_64-dvd.iso
# 获取pid：2032611

# 另开窗口注入故障，interface需根据自己机器修改
./blade create network loss --percent 40 --interface ens160

# /etc/gala-gopher/gala-gopher.conf gala-gopher的event先配置输出到logs
```

探针：  proc_id配置为要检测的进程，cluster_ip_backend=2
```
curl -X PUT http://localhost:9999/tcp -d json='
{
    "cmd": {
        "probe": [
            "tcp_abnormal",
            "tcp_rtt",
            "tcp_windows",
            "tcp_rate",
            "tcp_srtt",
            "tcp_sockbuf",
            "tcp_stats",
            "tcp_delay"
        ]
    },
    "snoopers": {
        "proc_id": [2032611]
    },
    "params":{
        "sample_period": 200,
        "report_period": 5,
        "latency_thr": 10,
        "drops_thr": 10,
        "res_lower_thr": 20,
        "res_upper_thr": 40,
        "report_event": 1,
        "cluster_ip_backend": 2
    },
    "state": "running"
}'
```

`/var/log/gala-gopher/event`日志中能看到异常事件：
```
{"Timestamp":1762222091000,"event_id":"1762222091000_fc214d56-657e-2c2d-7b3e-ace4653752d0-192.168.140.132_tcp_link_2032611_client_192.168.140.132_169.229.200.70_443_2","Attributes":{"entity_id":"fc214d56-657e-2c2d-7b3e-ace4653752d0-192.168.140.132_tcp_link_2032611_client_192.168.140.132_169.229.200.70_443_2","event_id":"1762222091000_fc214d56-657e-2c2d-7b3e-ace4653752d0-192.168.140.132_tcp_link_2032611_client_192.168.140.132_169.229.200.70_443_2","event_type":"sys"},"Resource":{"metric":"gala_gopher_tcp_link_sk_drops","labels":{"Host":"fc214d56-657e-2c2d-7b3e-ace4653752d0-192.168.140.132","PID":"2032611","COMM":"wget","IP":"CIP(192.168.140.132), SIP(169.229.200.70:443)","ContainerID":"","POD":"","Device":""}},"SeverityText":"WARN","SeverityNumber":13,"Body":"Tue Nov  4 10:08:11 2025 WARN Entity(2032611_client_192.168.140.132_169.229.200.70_443_2) Number of lost packets in the TCP protocol stack(150401)."}
```

可以通过查看丢包信息查看是否已经产生异常事件：  
```
curl -s http://localhost:8888 | grep -i drop
```

kafka存储的metadata和event显示：  
``` 
./bin/kafka-console-consumer.sh --bootstrap-server 192.168.140.132:9092 --topic gala_gopher_metadata --from-beginning
./bin/kafka-console-consumer.sh --bootstrap-server 192.168.140.132:9092 --topic gala_gopher_event --from-beginning
```

### 容器干扰检测
创建cloudsuite系列容器：  
`https://github.com/parsa-epfl/cloudsuite/`

```
docker create --name wikimedia-dataset cloudsuite/wikimedia-pages-dataset 
docker run -d --net host --volumes-from wikimedia-dataset --name data-master cloudsuite/data-analytics --master
docker run -d --net host --name data-slave01 cloudsuite/data-analytics --slave --master-ip=192.168.140.132
docker run -d --net host --name data-slave02 cloudsuite/data-analytics --slave --master-ip=192.168.140.132
```
运行benchmark:  
`docker exec data-master benchmark`

容器干扰检测器所在配置：  
`config/module/container_disruption.job.json`  
探针：  
```
curl -X PUT http://localhost:9999/container \
-d 'json={
  "cmd": {
    "probe": []
  },
  "snoopers": {
    "container_id": ["bd86ba1f5fa6"]
  },
  "params": {
    "cadvisor_port": 8083,
    "report_period": 5,

  },
  "state": "running"
}'
```
查看探针运行情况：
`curl -X GET http://localhost:9999/container`
查看sliprobe探针情况：
`curl -X GET http://localhost:9999/sli`

查看gala-anteater输出：  
```
./bin/kafka-console-consumer.sh --bootstrap-server 192.168.140.132:9092 --topic gala_anteater_hybrid_model --from-beginning
```

## Grafana图形化显示
```
yum install grafana

systemctl start grafana-server
systemctl status grafana-server
# 端口3000

# 账号密码：admin/admin

# 新增datasource
# new dashboarh, new panel, 选择query的指标

# 要注意系统时间，时间不对，会导致无法找到数据
```

## 参考链接
> https://docs.openeuler.org/zh/docs/22.03_LTS_SP3/docs/A-Ops/AOps%E9%83%A8%E7%BD%B2%E6%8C%87%E5%8D%97.html

> https://docs.openeuler.org/zh/docs/22.03_LTS_SP3/docs/A-Ops/gala-anteater%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C.html

> https://docs.openeuler.org/zh/docs/24.03_LTS_SP2/server/maintenance/gala/using_gala_anteater.html#%E5%AE%89%E8%A3%85

> https://blog.csdn.net/Maogaopeng/article/details/148306147

> https://blog.csdn.net/varyall/article/details/115875965

> https://gitee.com/openeuler/gala-gopher/blob/master/config/gala-gopher%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1_v0.3.md#%E6%8E%A2%E9%92%88%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B

> https://developer.aliyun.com/article/1109609